<!doctype html>
<html class="no-js" lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>TĐ Mobile - Báo cáo thống kê</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/png" href="assets/images/icon/favicon.ico" th:href="@{/assets/images/icon/favicon.ico}">
    <link rel="stylesheet" href="assets/css/bootstrap.min.css" th:href="@{/assets/css/bootstrap.min.css}">
    <link rel="stylesheet" href="assets/css/font-awesome.min.css" th:href="@{/assets/css/font-awesome.min.css}">
    <link rel="stylesheet" href="assets/css/themify-icons.css" th:href="@{/assets/css/themify-icons.css}">
    <link rel="stylesheet" href="assets/css/metisMenu.css" th:href="@{/assets/css/metisMenu.css}">
    <link rel="stylesheet" href="assets/css/owl.carousel.min.css" th:href="@{/assets/css/owl.carousel.min.css}">
    <link rel="stylesheet" href="assets/css/slicknav.min.css" th:href="@{/assets/css/slicknav.min.css}">
    <link rel="stylesheet" href="https://www.amcharts.com/lib/3/plugins/export/export.css" type="text/css" media="all" />
    <link rel="stylesheet" href="assets/css/typography.css" th:href="@{/assets/css/typography.css}">
    <link rel="stylesheet" href="assets/css/default-css.css" th:href="@{/assets/css/default-css.css}">
    <link rel="stylesheet" href="assets/css/styles.css" th:href="@{/assets/css/styles.css}">
    <link rel="stylesheet" href="assets/css/responsive.css" th:href="@{/assets/css/responsive.css}">
    <script src="assets/js/vendor/modernizr-2.8.3.min.js" th:href="@{/assets/js/vendor/modernizr-2.8.3.min.js}"></script>
    <script src="/assets/js/pending-orders-badge.js" th:src="@{/assets/js/pending-orders-badge.js}"></script>
    <style>
        .report-content {
            display: none;
        }
        .report-content.active {
            display: block;
        }
        .card-title {
            font-weight: 600;
        }
        .row.d-flex {
            display: flex;
            flex-wrap: wrap;
        }
        .row.d-flex > [class*="col-"] {
            display: flex;
            flex-direction: column;
        }
        .card {
            height: 100%;
        }
    </style>
</head>

<body>
<div id="preloader">
    <div class="loader"></div>
</div>
<div class="page-container">
    <!-- sidebar menu area start -->
    <div th:replace="~{Fragments/sidebar :: *}"></div>
    <!-- sidebar menu area end -->

    <!-- Main Content -->
    <div class="main-content">
        <!-- header area start -->
        <div th:replace="~{Fragments/header :: *}"></div>
        <!-- header area end -->

        <!-- Page Title -->
        <div class="page-title-area">
            <div class="row align-items-center">
                <div class="col-sm-6">
                    <div class="breadcrumbs-area clearfix">
                        <h4 class="page-title pull-left">Báo cáo thống kê</h4>
                        <ul class="breadcrumbs pull-left">
                            <li><a href="/management/dashboard">Trang chủ</a></li>
                            <li><span>Báo cáo thống kê</span></li>
                        </ul>
                    </div>
                </div>
                <div class="col-sm-6 clearfix">
                    <div class="user-profile pull-right">
                        <img class="avatar user-thumb" src="../../static/assets/images/author/avatar.png" alt="avatar" th:src="@{/assets/images/author/avatar.png}">
                        <h4 class="user-name dropdown-toggle" data-toggle="dropdown" th:text="${username}"><i class="fa fa-angle-down"></i></h4>
                        <div class="dropdown-menu">
                            <a class="dropdown-item" href="#">Thông báo</a>
                            <a class="dropdown-item" href="#">Cài đặt</a>
                            <a class="dropdown-item" href="/logout">Đăng xuất</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Inner -->
        <div class="main-content-inner">
            <div class="container-fluid mt-4">
                <!-- Filter Section -->
                <form th:action="@{/management/statistical-report/filter}" method="get" th:object="${filter}" class="row mb-4 align-items-end">
                    <div class="col-md-3">
                        <label for="reportType">Loại báo cáo</label>
                        <select id="reportType" class="form-control" th:field="*{reportType}" onchange="switchReportView()" style="height: 2.5rem;">
                            <option value="revenue">Doanh thu</option>
                            <option value="products">Sản phẩm</option>
                            <option value="customers">Khách hàng</option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <label for="startDate" class="mr-2 text-nowrap">Từ ngày <span class="text-danger">*</span></label>
                            <small class="text-danger" th:if="${errorStartDate}" th:text="${errorStartDate}"></small>
                        </div>
                        <input type="date" id="startDate" class="form-control" th:field="*{startDate}" style="height: 2.5rem;">
                    </div>

                    <div class="col-md-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <label for="endDate" class="mr-2 text-nowrap">Đến ngày <span class="text-danger">*</span></label>
                            <small class="text-danger" th:if="${errorEndDate}" th:text="${errorEndDate}"></small>
                        </div>
                        <input type="date" id="endDate" class="form-control" th:field="*{endDate}" style="height: 2.5rem;">
                    </div>

                    <div class="col-md-3 d-flex">
                        <button type="submit" class="btn btn-primary mr-2 flex-fill" name="action" value="filter">
                            <i class="fa fa-filter"></i> Lọc
                        </button>
                        <button type="submit" class="btn btn-success flex-fill" name="action" value="export">
                            <i class="fa fa-download"></i> Xuất báo cáo
                        </button>
                    </div>
                </form>



                <!-- Revenue Report -->
                <div id="revenue-report" class="report-content active">
                    <div class="row d-flex">
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card card-bordered">
                                <div class="card-body">
                                    <h5 class="card-title">Tổng doanh thu</h5>
                                    <h4 id="total-revenue" class="text-primary" th:text="${totalRevenue != null} ? ${#numbers.formatDecimal(totalRevenue, 0, 'POINT', 0, 'POINT') + 'đ'} : 'N/A'"></h4>
<!--                                    <p class="text-success mb-0"><i class="fa fa-arrow-up"></i> 15%</p>-->
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card card-bordered">
                                <div class="card-body">
                                    <h5 class="card-title">Tổng số đơn hàng</h5>
                                    <h4 id="total-orders" class="text-info" th:text="${totalOrders != null} ? ${totalOrders} : 'N/A'"></h4>
<!--                                    <p class="text-success mb-0"><i class="fa fa-arrow-up"></i> 10%</p>-->
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card card-bordered">
                                <div class="card-body">
                                    <h5 class="card-title">TB giá trị đơn hàng</h5>
                                    <h4 id="avg-order-value" class="text-secondary" th:text="${avgOrder != null} ? ${#numbers.formatDecimal(avgOrder, 0, 'POINT', 0, 'POINT') + 'đ'} : 'N/A'"></h4>
<!--                                    <p class="text-success mb-0"><i class="fa fa-arrow-up"></i> 5%</p>-->
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card card-bordered">
                                <div class="card-body">
                                    <h5 class="card-title">Tổng số đơn bị hủy</h5>
                                    <h4 id="today-revenue" class="text-warning" th:text="${canceledOrders != null} ? ${canceledOrders} : 'N/A'"></h4>
<!--                                    <p class="text-danger mb-0"><i class="fa fa-arrow-down"></i> 2%</p>-->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row d-flex">
                        <div class="col-lg-8 mb-4">
                            <div class="card"><div class="card-body"><h5 class="card-title">Doanh thu kỳ trước và kỳ này</h5><canvas id="monthlyTotalRevenueChart"></canvas></div></div>
                        </div>
                        <div class="col-lg-4 mb-4">
                            <div class="card"><div class="card-body"><h5 class="card-title">Doanh thu theo phương thức thanh toán</h5><canvas id="paymentMethodChart"></canvas></div></div>
                        </div>
                    </div>
                    <div class="row d-flex">
                        <div class="col-lg-12 mb-4">
                            <div class="card"><div class="card-body"><h5 class="card-title">Doanh thu theo danh mục sản phẩm</h5><canvas id="categoryRevenueChart"></canvas></div></div>
                        </div>
                    </div>
                    <div class="row d-flex">
                        <div class="col-lg-12 mb-4">
                            <div class="card"><div class="card-body"><h5 class="card-title">Biểu đồ doanh thu theo thời gian</h5><canvas id="revenueChart"></canvas></div></div>
                        </div>
                    </div>
                </div>

                <!-- Best Sellers Report -->
                <div id="products-report" class="report-content">
                    <div class="row d-flex">
                        <div class="col-lg-8 mb-4">
                            <div class="card"><div class="card-body"><h5 class="card-title">Top 10 sản phẩm bán chạy nhất</h5><canvas id="bestSellersChart"></canvas></div></div>
                        </div>
                        <div class="col-lg-4 mb-4">
                            <div class="card"><div class="card-body"><h5 class="card-title">Sản phẩm bán ít nhất</h5>
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead><tr><th>Sản phẩm</th><th>Còn lại</th></tr></thead>
                                        <tbody>
                                        <tr th:each="lowSellingProduct: ${lowSellingProducts}">
                                            <td th:text="${lowSellingProduct.name + ' - ' + (lowSellingProduct.rom >= 1000 ? (lowSellingProduct.rom / 1000) + 'TB' : lowSellingProduct.rom + 'GB')}"></td>
                                            <td th:text="${lowSellingProduct.totalQuantity}" class="badge badge-warning"></td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 mb-4"><div class="card"><div class="card-body"><h5 class="card-title">Chi tiết sản phẩm bán chạy</h5><div class="table-responsive"><table class="table table-bordered text-center">
                            <thead class="bg-light"><tr><th>Hạng</th><th>Mã SP</th><th>Tên sản phẩm</th><th>Màu</th><th>ROM</th><th>Doanh thu</th><th>Đã bán</th></tr></thead>
                            <tbody>
                            <tr th:each="bestSellingProduct, idex : ${bestSellingProducts}">
                                <td th:text="${idex.index + 1}"></td>
                                <td th:text="${bestSellingProduct.productId}"></td>
                                <td th:text="${bestSellingProduct.name}"></td>
                                <td th:text="${bestSellingProduct.color}"></td>
                                <td th:text="${bestSellingProduct.rom >= 1000 ? (bestSellingProduct.rom / 1000) + 'TB' : bestSellingProduct.rom + 'GB'}"></td>
                                <td th:text="${#numbers.formatDecimal(bestSellingProduct.sellingPrice, 0, 'POINT', 0, 'POINT') + 'đ'}"></td>
                                <td th:text="${bestSellingProduct.totalQuantity}"></td>
                            </tr>
                            </tbody>
                        </table></div></div></div></div>
                    </div>
                </div>

                <!-- Customers Report -->
                <div id="customers-report" class="report-content">
                    <div class="row d-flex">
                        <div class="col-lg-4 col-md-6 mb-4"><div class="card card-bordered"><div class="card-body"><h5 class="card-title">Tổng số khách hàng</h5><h4 class="text-primary" th:text="${totalCustomers != null} ? ${totalCustomers} : 'N/A'"></h4></div></div></div>
                        <div class="col-lg-4 col-md-6 mb-4"><div class="card card-bordered"><div class="card-body"><h5 class="card-title">Tổng số khách hàng mới</h5><h4 class="text-info" th:text="${totalNewCustomers != null} ? ${totalNewCustomers} : 'N/A'"></h4></div></div></div>
                        <div class="col-lg-4 col-md-6 mb-4"><div class="card card-bordered"><div class="card-body"><h5 class="card-title">Đơn hàng trung bình/KH</h5><h4 class="text-secondary" th:text="${calculateAverageOrdersPerCustomer != null} ? ${calculateAverageOrdersPerCustomer} : 'N/A'"></h4></div></div></div>
                    </div>
                    <div class="row d-flex">
                        <div class="col-lg-4 mb-4">
                            <div class="card"><div class="card-body"><h5 class="card-title">Phân loại khách hàng</h5><canvas id="customerSegmentsChart"></canvas></div></div>
                        </div>
                        <div class="col-lg-8 mb-4">
                            <div class="card"><div class="card-body"><h5 class="card-title">Top 10 khách hàng tiềm năng</h5><div class="table-responsive"><table class="table table-bordered text-center">
                                <thead class="bg-light"><tr><th>Hạng</th><th>Mã KH</th><th>Tên khách hàng</th><th>Tổng chi tiêu</th><th>Số đơn hàng</th></tr></thead>
                                <tbody>
                                <tr th:each="customer, idex : ${topCustomers}">
                                    <td th:text="${idex.index + 1}"></td>
                                    <td th:text="${customer.userId}"></td>
                                    <td th:text="${customer.fullname}"></td>
                                    <td th:text="${#numbers.formatDecimal(customer.totalSpent, 0, 'POINT', 0, 'POINT') + 'đ'}"></td>
                                    <td th:text="${customer.totalOrders}"></td>
                                </tr>
                                </tbody>
                            </table></div></div></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- footer area start-->
    <div th:replace="~{Fragments/footer :: *}"></div>
    <!-- footer area end-->
</div>

<script src="assets/js/vendor/jquery-2.2.4.min.js" th:src="@{/assets/js/vendor/jquery-2.2.4.min.js}"></script>
<script src="assets/js/popper.min.js" th:src="@{/assets/js/popper.min.js}"></script>
<script src="assets/js/bootstrap.min.js" th:src="@{/assets/js/bootstrap.min.js}"></script>
<script src="assets/js/owl.carousel.min.js" th:src="@{/assets/js/owl.carousel.min.js}"></script>
<script src="assets/js/metisMenu.min.js" th:src="@{/assets/js/metisMenu.min.js}"></script>
<script src="assets/js/jquery.slimscroll.min.js" th:src="@{/assets/js/jquery.slimscroll.min.js}"></script>
<script src="assets/js/jquery.slicknav.min.js" th:src="@{/assets/js/jquery.slicknav.min.js}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="assets/js/plugins.js" th:src="@{/assets/js/plugins.js}"></script>
<script src="assets/js/scripts.js" th:src="@{/assets/js/scripts.js}"></script>

<script th:inline="javascript">
    /*<![CDATA[*/
    let revenueByDay = /*[[${revenueByDay}]]*/ {};
    let paymentMethod = /*[[${paymentMethod}]]*/ {};
    let revenueByCategory = /*[[${revenueByCategory}]]*/ {};
    let revenueComparison = /*[[${revenueComparison}]]*/ {};
    let classifyCustomersBySpending = /*[[${classifyCustomersBySpending}]]*/ {};
    let bestSellingProducts = /*[[${bestSellingProducts}]]*/ [];
    let bestSellersChart = null;
    /*]]>*/

    function switchReportView() {
      const reportType = document.getElementById('reportType').value;
      document.querySelectorAll('.report-content').forEach(el => el.classList.remove('active'));
      document.getElementById(reportType + '-report')?.classList.add('active');

      if (reportType === 'products') {
        setTimeout(() => {
          renderBestSellersChart(); // render sau khi tab hiện
        }, 200);
      }
    }

    function formatCurrency(value) {
      return value.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
    }

    document.addEventListener('DOMContentLoaded', function() {
      const selectedReportType = /*[[${selectedReportType}]]*/ 'revenue';

      // Hiển thị đúng tab sau khi submit form
      document.querySelectorAll('.report-content').forEach(el => el.classList.remove('active'));
      document.getElementById(selectedReportType + '-report')?.classList.add('active');

      switchReportView();

      // 1. Revenue Comparison Chart
      const ctxCompare = document.getElementById('monthlyTotalRevenueChart')?.getContext('2d');
      if (ctxCompare) {
        new Chart(ctxCompare, {
          type: 'bar',
          data: {
            labels: Object.keys(revenueComparison),
            datasets: [{
              label: 'Doanh thu',
              data: Object.values(revenueComparison),
              backgroundColor: ['#36a2eb', '#4bc0c0']
            }]
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: val => formatCurrency(val)
                }
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: ctx => formatCurrency(ctx.parsed.y)
                }
              }
            }
          }
        });
      }

      // 2. Revenue By Day Chart
      const ctxR = document.getElementById('revenueChart')?.getContext('2d');
      if (ctxR) {
        new Chart(ctxR, {
          type: 'line',
          data: {
            labels: Object.keys(revenueByDay),
            datasets: [{
              label: 'Doanh thu',
              data: Object.values(revenueByDay),
              borderColor: '#36a2eb',
              backgroundColor: 'rgba(54, 162, 235, 0.2)',
              tension: 0.4
            }]
          },
          options: {
            plugins: {
              tooltip: {
                callbacks: {
                  label: ctx => formatCurrency(ctx.parsed.y)
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: val => formatCurrency(val)
                }
              }
            }
          }
        });
      }

      // 3. Payment Method Chart
      const ctxP = document.getElementById('paymentMethodChart')?.getContext('2d');
      if (ctxP) {
        new Chart(ctxP, {
          type: 'pie',
          data: {
            labels: Object.keys(paymentMethod),
            datasets: [{
              data: Object.values(paymentMethod),
              backgroundColor: ['#36a2eb', '#ff6384', '#ffcd56'],
            }]
          }
        });
      }

      // 4. Category Revenue Chart
      const ctxC = document.getElementById('categoryRevenueChart')?.getContext('2d');
      if (ctxC) {
        new Chart(ctxC, {
          type: 'bar',
          data: {
            labels: Object.keys(revenueByCategory),
            datasets: [{
              label: 'Doanh thu',
              data: Object.values(revenueByCategory),
              backgroundColor: '#4bc0c0',
            }]
          },
          options: {
            scales: {
              y: {
                ticks: {
                  callback: val => formatCurrency(val)
                }
              }
            }
          }
        });

        // 5. classifyCustomersBySpending
          const ctxP = document.getElementById('customerSegmentsChart')?.getContext('2d');
          if (ctxP) {
            new Chart(ctxP, {
              type: 'pie',
              data: {
                labels: Object.keys(classifyCustomersBySpending),
                datasets: [{
                  data: Object.values(classifyCustomersBySpending),
                  backgroundColor: ['#8BC34A', '#FFC107', '#FF7043', '#42A5F5'],
                }]
              }
            });
          }
      }

      // 5. Chỉ render Best Sellers nếu đang ở tab "products"
    if (selectedReportType === 'products') {
        setTimeout(() => {
          renderBestSellersChart();
        }, 200);
      }
    });
    // Best Sellers Chart
    function renderBestSellersChart() {
      const canvas = document.getElementById('bestSellersChart');
      if (!canvas) return;

      const ctx = canvas.getContext('2d');

      if (bestSellersChart) {
        bestSellersChart.destroy();
      }

      const productNames = bestSellingProducts.map(p => {
          const rom = parseInt(p.rom);
          const formattedRom = rom >= 1000 ? (rom / 1000).toFixed(rom % 1000 === 0 ? 0 : 1) + 'TB' : rom + 'GB';
          return `${p.name} - ${formattedRom}`;
      });
      const quantitiesSold = bestSellingProducts.map(p => p.totalQuantity);
      const productRom = bestSellingProducts.map(p => {
        const rom = parseInt(p.rom);
        return rom >= 1000 ? (rom / 1000).toFixed(rom % 1000 === 0 ? 0 : 1) + 'TB' : rom + 'GB';
      });

      bestSellersChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: productNames,
          datasets: [{
            label: 'Số lượng đã bán',
            data: quantitiesSold,
            backgroundColor: '#ff9f40'
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: val => val + ' SP'
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.label}: ${ctx.parsed.y} sản phẩm`
              }
            }
          }
        }
      });
    }
</script>

</body>
</html>

